% REQUIRED CMD-LINE PARAMS: $seeds, $nOfEvals, $innerLayers

@import("imports/cases.txt")
@import("imports/problem.txt")
%@import("imports/problemFF.txt")
@import("imports/listeners.txt")

$weightsUpdateInterval = 1
$initialWeightRange = m.range(min = -0.01; max = 0.01)

$dIncrease = ea.s.me.d.descriptor(f = f.mapValue(key = increase; of = ea.f.quality()); min = 0.0; max = 1.0; nOfBins = 10)
$dConsistency = ea.s.me.d.descriptor(f = f.mapValue(key = consistency; of = ea.f.quality()); min = 0.0; max = 0.2; nOfBins = 10)

$mlpMapper = ea.mapper.ndsToNrla(of = ea.mapper.dsToParametrized(parametrized = ds.num.mlp(innerLayers = $innerLayers)))
$hebbianSynMapper = ea.mapper.ndsToNrla(of = ea.mapper.dsToParametrized(parametrized = ds.num.hebbianMlp(
    innerLayers = $innerLayers; 
    parametrizationType = synapse; 
    weightInitializationType = random; 
    weightsUpdateInterval = $weightsUpdateInterval; 
    initialWeightRange = $initialWeightRange
)))
$hebbianNetMapper = ea.mapper.ndsToNrla(of = ea.mapper.dsToParametrized(parametrized = ds.num.hebbianMlp(
    innerLayers = $innerLayers; 
    parametrizationType = network; 
    weightInitializationType = random; 
    weightsUpdateInterval = $weightsUpdateInterval; 
    initialWeightRange = $initialWeightRange
)))
$freeFormMapper = ea.mapper.parametrized(of = ea.mapper.srTreeToNurf(); parametrized = ds.rl.num.freeFormMlp(
    innerLayers = $innerLayers; 
    weightInitializationType = random; 
    weightsUpdateInterval = $weightsUpdateInterval; 
    initialWeightRange = $initialWeightRange
))

ea.experiment(
  runs = (randomGenerator = (seed = $seeds) * [m.defaultRG()])
  * (problem = [$problem])
  * (solver = (stop = ea.sc.nOfQualityEvaluations(n = $nOfEvals)) * [
    ea.s.mapElites(
      name = "me-hebbian-synapse";
      representation = ea.representation.doubleString();
      mapper = $hebbianSynMapper;
      descriptors = [$dIncrease; $dConsistency];
      remap = true
    );
    ea.s.mapElites(
      name = "me-hebbian-network";
      representation = ea.representation.doubleString();
      mapper = $hebbianNetMapper;
      descriptors = [$dIncrease; $dConsistency];
      remap = true
    );
    ea.s.mapElites(
      name = "me-freeForm";
      representation = ea.r.srTree(
        ephemeral = true;
        operators = [addition; subtraction; multiplication; prot_division; prot_log; max; min; tanh; gt; lt; ternary]
        %operators = [addition; subtraction; multiplication];
        %includeVarNameRegex = "current_neuronPost_activation|current_neuronPre_activation|layeIdx|preSynapticNeuronIdx|postSynapticNeuronIdx"
      );
      mapper = $freeFormMapper;
      descriptors = [$dIncrease; $dConsistency];
      remap = true
    )
  ])
  * [ea.run()];
  listeners = [
    $console;
    $consoleCSV;
    $avgLastBoolScore;
    $increase;
    $consistency;
    %$frozen;
    $frozenScore;
    $longerLife;
    $stateTraj;
    $archivesP;
    $srTree
  ]
)