$basePath = ''./results/xor/shuffled/{^^.name}/{^^.startTime}/''
$imgType = svg

$console = ea.l.console(
  eFunctions = [
    ea.f.size(of = ea.f.genotype(of = ea.f.best()); format = "%4d");
    f.mapValue(key = avgLastBoolScore; of = ea.f.quality(of = ea.f.best()); format = "%6.4f")
  ];
  kFunctions = [
    f.replaceAll(of = f.interpolated(name = numberOfInnerLayers; s = "{solver.mapper.of.parametrized.innerLayers}{solver.mapper.parametrized.innerLayers}"); regex="null")
  ];
  onlyLast = true
)

$consoleCSV = ea.l.csv(
  path = $basePath + "console.csv";
  eFunctions = [
    ea.f.size(of = ea.f.genotype(of = ea.f.best()); format = "%4d");
    f.mapValue(key = avgLastBoolScore; of = ea.f.quality(of = ea.f.best()); format = "%6.4f");
    f.mapValue(key = increase; of = ea.f.quality(of = ea.f.best()); format = "%6.4f");
    f.mapValue(key = consistency; of = ea.f.quality(of = ea.f.best()); format = "%6.4f")
  ];
  kFunctions = [
    f.replaceAll(of = f.interpolated(name = numberOfInnerLayers; s = "{solver.mapper.of.parametrized.innerLayers}{solver.mapper.parametrized.innerLayers}"); regex="null")
  ];
  onlyLast = true
)

$avgLastBoolScore = ea.l.savePlotForExp(
  path = $basePath + "avgLastBoolScore." + $imgType;
  plot = ea.plot.multi.quality(
    q = f.mapValue(key = avgLastBoolScore)
  );
  type = $imgType
)

$avgLastUnlimitedScore = ea.l.savePlotForExp(
  path = $basePath + "avgLastUnlimitedScore." + $imgType;
  plot = ea.plot.multi.quality(
    q = f.mapValue(key = avgLastUnlimitedScore)
  );
  type = $imgType
)

$increase = ea.l.savePlotForExp(
  path = $basePath + "increase." + $imgType;
  plot = ea.plot.multi.quality(
    q = f.mapValue(key = increase)
  );
  type = $imgType
)

$consistency = ea.l.savePlotForExp(
  path = $basePath + "consistency." + $imgType;
  plot = ea.plot.multi.quality(
    q = f.mapValue(key = consistency)
  );
  type = $imgType
)

$frozenBehavior = ea.l.saveForRun(
  path = $basePath + "/frozen" + "/{problem.name}/{solver.name}/{randomGenerator.seed:%02d}." + $imgType;
  of = ea.acc.lastBest();
  processor = viz.f.toImage(
    drawer = ds.d.sequentialXor();
    of = ds.f.simulate(
      of = ds.f.asNumericalRLAgent(of = ds.f.stateless(of = ds.f.nonLearning(of = ea.f.solution())));
      dT = 1;
      tRange = $tRangeForFreeze;
      simulation = ds.s.sequentialXor(
        cases = $cases;
        resetAgent = true;
        shuffle = true
      )
    );
    h = 180;
    type = $imgType
  )
)

$frozenScore = ea.l.savePlotForExp(
  path = $basePath + "frozenScore." + $imgType;
  plot = ea.plot.multi.xyExp(
    y = ds.e.sxor.avgScore(
      rewardType = unlimited;
      caseIndexes = [0:1:7];
      of = ds.f.simulate(
        of = ds.f.asNumericalRLAgent(of = ds.f.stateless(of = ds.f.nonLearning(of = ea.f.solution(of = ea.f.best()))));
        dT = 1;
        tRange = $tRangeForFreeze;
        simulation = ds.s.sequentialXor(
          cases = $cases;
          resetAgent = true;
          shuffle = true
        )
      )
    )
  );
  type = $imgType
)

$longerLife = ea.l.savePlotForExp(
  path = $basePath + "avgOnAnotherLife." + $imgType;
  plot = ea.plot.multi.xyExp(
    y = ds.e.sxor.avgScore(
      rewardType = unlimited;
      caseIndexes = [-40:1:-1];     % last 40 cases
      of = ds.f.simulate(
        of = ea.f.solution(of = ea.f.best());
        dT = 1;
        tRange = $tRangeDoubleLife;
        simulation = ds.s.sequentialXor(
          cases = $cases + $cases;
          rewardType = unlimited;
          resetAgent = true;
          shuffle = true
        )
      )
    )
  );
  type = $imgType
)

$stateTraj = ea.l.saveForRun(
  path = $basePath + "/state" + "/{solver.name}/{randomGenerator.seed:%02d}." + $imgType;
  of = ea.acc.lastBest();
  processor = viz.f.toImage(
    drawer = ds.d.vectorialTrajectory();
    of = ds.f.agentStateTrajectory(
      of = ea.f.solution();
      stateF = ds.f.params();
      sat = ds.s.sequentialXor(
        cases = $cases; 
        resetAgent = true;
        shuffle = true
      );
      dT = 1;
      tRange = $tRangeLife
    );
    type = $imgType
  )
)