$basePath = ''./results/xor/local/{^^.name}/{^^.startTime}/''
$imgType = svg

$console = ea.l.console(
  eFunctions = [
    ea.f.size(of = ea.f.genotype(of = ea.f.best()); format = "%4d");
    f.mapValue(key = avgLastBoolScore; of = ea.f.quality(of = ea.f.best()); format = "%6.4f")
  ];
  kFunctions = [
    f.replaceAll(of = f.interpolated(name = numberOfInnerLayers; s = "{solver.mapper.of.parametrized.innerLayers}{solver.mapper.parametrized.innerLayers}"); regex="null")
  ];
  onlyLast = true
)

$avgLastBoolScore = ea.l.savePlotForExp(
  path = $basePath + "avgLastBoolScore." + $imgType;
  plot = ea.plot.multi.quality(
    q = f.mapValue(key = avgLastBoolScore)
  );
  type = $imgType
)

$increase = ea.l.savePlotForExp(
  path = $basePath + "increase." + $imgType;
  plot = ea.plot.multi.quality(
    q = f.mapValue(key = increase)
  );
  type = $imgType
)

$consistency = ea.l.savePlotForExp(
  path = $basePath + "consistency." + $imgType;
  plot = ea.plot.multi.quality(
    q = f.mapValue(key = consistency)
  );
  type = $imgType
)

$behaviorLastSeq = ea.l.saveForRun(
  path = $basePath + "/behavior" + "/{problem.name}/{solver.name}/{randomGenerator.seed:%02d}." + $imgType;
  of = ea.acc.lastBest();
  processor = viz.f.toImage(
    drawer = ds.d.sequentialXor(
      rewardTypes = [boolean; unlimited]
    ); 
    of = ds.f.simulate(
      of = ea.f.solution();
      dT = 1;
      tRange = $tRangeTest;
      simulation = ds.s.sequentialXor(
        cases = $testCases;
        rewardType = unlimited;
        resetAgent = true
      )
    );
    h = 180;
    type = $imgType
  )
)

$trajsAfterFreeze = ea.l.saveForRun(
  path = $basePath + "/AF" + "/{problem.name}/{solver.name}/{randomGenerator.seed:%02d}." + $imgType;
  of = ea.acc.lastBest();
  processor = viz.f.toImage(
    drawer = ds.d.sequentialXor();
    of = ds.f.simulate(
      of = ds.f.asNumericalRLAgent(of = ds.f.stateless(of = ds.f.nonLearning(of = ea.f.solution())));
      dT = 1;
      tRange = m.range(min = 0; max = 8);
      simulation = ds.s.sequentialXor(
        cases = $testCases
      )
    );
    h = 180;
    type = $imgType
  )
)

$anotherLife = ea.l.savePlotForExp(
  path = $basePath + "avgOnAnotherLife." + $imgType;
  plot = ea.plot.multi.xyExp(
    y = ds.e.sxor.avgScore(
      rewardType = boolean;
      caseIndexes = [-50:1:-1];
      of = ds.f.simulate(
        of = ea.f.solution(of = ea.f.best());
        dT = 1;
        tRange = m.range(min = 0; max = 190);
        simulation = ds.s.sequentialXor(
          cases = $heteroCases + $testCases + $testCases;
          rewardType = unlimited;
          resetAgent = true
        )
      )
    )
  );
  type = $imgType
)

$afterFreeze = ea.l.savePlotForExp(
  path = $basePath + "avgOnAfterFreeze." + $imgType;
  plot = ea.plot.multi.xyExp(
    y = ds.e.sxor.avgScore(
      rewardType = boolean;
      caseIndexes = [0:1:7];
      of = ds.f.simulate(
        of = ds.f.asNumericalRLAgent(of = ds.f.stateless(of = ds.f.nonLearning(of = ea.f.solution(of = ea.f.best()))));
        dT = 1;
        tRange = m.range(min = 0; max = 8);
        simulation = ds.s.sequentialXor(
          cases = $testCases
        )
      )
    )
  );
  type = $imgType
)

$stateTraj = ea.l.saveForRun(
  path = $basePath + "/state" + "/{problem.name}/{solver.name}/{randomGenerator.seed:%02d}." + $imgType;
  of = ea.acc.lastBest();
  processor = viz.f.toImage(
    drawer = ds.d.vectorialTrajectory();
    of = ds.f.agentStateTrajectory(
      of = ea.f.solution();
      stateF = ds.f.params();
      sat = ds.s.sequentialXor(cases = $heteroCases; resetAgent = true);
      dT = 1;
      tRange = m.range(min = 0; max = 140)
    );
    type = $imgType
  )
)