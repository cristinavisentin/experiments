$basePath = ''./results/navigation/local/{^^.name}/{^^.startTime}/''
$imgType = svg

$console = ea.l.console(
  eFunctions = [
    ea.f.size(of = ea.f.genotype(of = ea.f.best()); format = "%4d");
    f.mapValue(key = fitness; of = ea.f.quality(of = ea.f.best()); format = "%6.4f");
    f.mapValue(key = increase; of = ea.f.quality(of = ea.f.best()); format = "%6.4f");
    f.mapValue(key = consistency; of = ea.f.quality(of = ea.f.best()); format = "%6.4f")
  ];
  onlyLast = true
)

$consoleCSV = ea.l.csv(
  path = $basePath + "console.csv";
  eFunctions = [
    ea.f.size(of = ea.f.genotype(of = ea.f.best()); format = "%4d");
    f.mapValue(key = fitness; of = ea.f.quality(of = ea.f.best()); format = "%6.4f");
    f.mapValue(key = increase; of = ea.f.quality(of = ea.f.best()); format = "%6.4f");
    f.mapValue(key = consistency; of = ea.f.quality(of = ea.f.best()); format = "%6.4f")
  ]
)

$fitness = ea.l.savePlotAndCsvForExp(
  path = $basePath + "fitness." + $imgType;
  plot = ea.plot.multi.quality(
    q = f.mapValue(key = fitness)
  );
  type = $imgType
)

$increase = ea.l.savePlotAndCsvForExp(
  path = $basePath + "increase." + $imgType;
  plot = ea.plot.multi.quality(
    q = f.mapValue(key = increase)
  );
  type = $imgType
)

$consistency = ea.l.savePlotAndCsvForExp(
  path = $basePath + "consistency." + $imgType;
  plot = ea.plot.multi.quality(
    q = f.mapValue(key = consistency)
  );
  type = $imgType
)

$archives = ea.l.savePlotAndCsvForRun(
  path = $basePath + "/{solver.name}/me-archives-{randomGenerator.seed:%02d}." + $imgType;
  plot = ea.plot.single.me(values = [
    f.mapValue(key = fitness; of = ea.f.quality())
  ]);
  kCondition = predicate.matches(f = f.mappableKey(key = "solver.name"); regex = "me.*");
  type = $imgType
)

$frozenTrajs = ea.l.saveForRun(
  path = $basePath + "{solver.name}/best-frozen-learning-trajs-{randomGenerator.seed:%02d}." + $imgType;
  of = ea.acc.lastBest();
  processor = viz.f.toImage(
    drawer = ds.d.navigation();
    of = f.all(
      of = ds.f.stateless(of = ds.f.nonLearning(of = ea.f.solution()));
      fs = (simulation = (environment = $testEnviroment)
      * [ds.sat.fromEnvironment()])
      * [ds.f.simulate(dT = $dT; tRange = $tRange)]
    );
    type = $imgType
  )
)

%%%

$increaseCRFBoxplot = ea.l.savePlotAndCsvForExp(
  path = $basePath + "boxplot-increaseCRF." + $imgType;
  plot = ea.plot.multi.qualityBoxplot(
    q = $arenaIncreaseCRF;
    xSubplot = f.replaceAll(of = f.interpolated(name = numberOfInnerLayers; s = "{solver.mapper.of.parametrized.innerLayers}{solver.mapper.parametrized.innerLayers}"); regex="null")
  );
  type = $imgType
)

$consistencyCRFBoxplot = ea.l.savePlotAndCsvForExp(
  path = $basePath + "boxplot-consistencyCRF." + $imgType;
  plot = ea.plot.multi.qualityBoxplot(
    q = $arenaConsistencyCRF;
    xSubplot = f.replaceAll(of = f.interpolated(name = numberOfInnerLayers; s = "{solver.mapper.of.parametrized.innerLayers}{solver.mapper.parametrized.innerLayers}"); regex="null")
  );
  type = $imgType
)

$boxplotFinalDist = ea.l.savePlotAndCsvForExp(
  path = $basePath + "boxplot-best-test-arenas-avg-final.d." + $imgType;
  plot = ea.plot.multi.yBoxplotExp(
    y = f.avg(of = f.all(
      of = ds.f.stateless(of = ds.f.nonLearning(of = ea.f.solution(of = ea.f.best())));
      fs = (of = (simulation = (environment = $testEnviroment)
      * [ds.sat.fromEnvironment()])
      * [ds.f.simulate(dT = $dT; tRange = $tRange)])
      * [ds.e.n.finalD()]
    ));
    xSubplot = f.replaceAll(of = f.interpolated(name = numberOfInnerLayers; s = "{solver.mapper.of.parametrized.innerLayers}{solver.mapper.parametrized.innerLayers}"); regex="null")
  );
  type = $imgType
)